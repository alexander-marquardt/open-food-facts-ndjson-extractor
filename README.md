# off-demo-extract

Extract a clean **NDJSON** demo catalog from the Open Food Facts (OFF) JSONL export.

This repository contains **code only**. It does **not** ship Open Food Facts data or any derived dataset.

## What this produces

One JSON object per line (NDJSON) with:

- `id` (GTIN-13 padded)
- `title` (English)
- `description` (English; typically ingredients/generic name)
- `image_url` (computed from OFF `images` metadata)
- `price` (synthetic, deterministic)
- `currency`, `brand`, `categories_tags`, `lang`

Image URLs are constructed using OFF’s documented image URL scheme.

## Why this tool is necessary

The raw data from Open Food Facts is incredibly detailed but also complex, containing hundreds of fields, nested objects, and language-specific keys. This makes it difficult to use directly in many applications, especially search and recommendation engines that expect a simple, flat document structure.

This script transforms the raw data into a clean, consistent, and search-ready format. It performs several key operations:

*   **Selects a primary language:** It extracts titles and descriptions from a complex, multi-language structure into single `title` and `description` fields.
*   **Constructs a reliable image URL:** It navigates nested image metadata to build a single, high-quality `image_url`.
*   **Synthesizes a full description:** It combines the title, generic name, and key attributes into a comprehensive `description` field.
*   **Generates a synthetic price:** It creates a deterministic, plausible price to enable e-commerce simulations.
*   **Flattens the structure:** It extracts key attributes into a simple key-value `attrs` object.

### Before: Raw Open Food Facts Data Example

A single product can have over 500 fields. Key information like the product name or image URL is buried in nested objects and requires logic to extract.

```json
{
  "_id": "0000105000011",
  "product_name_en": "Chamomile Herbal Tea",
  "product_name": "Chamomile Herbal Tea",
  "ingredients_text_en": "CHAMOMILE FLOWERS.",
  "images": {
    "front_en": {
      "imgid": "some_id",
      "rev": "1",
      "sizes": {
        "400": { "h": 400, "w": 300 }
      }
    }
  },
  "nutriments": {
    "energy-kcal_100g": 280,
    "fat_100g": 0,
    "sugars_100g": 0
  },
  "...": "Many more fields..."
}
```

### After: Cleaned NDJSON for Search Example

The output is a clean, flat JSON object, ready to be indexed into a search engine like Elasticsearch or OpenSearch.

```json
{
  "id": "0000105000011",
  "title": "Chamomile Herbal Tea",
  "brand": "Lagg's",
  "description": "Chamomile Herbal Tea\\nCHAMOMILE FLOWERS.\\n\\nKey Specifications:\\n- **NOVA group**: 1\\n- **Energy (kcal/100g)**: 280 kcal\\n- **Fat (g/100g)**: 0 g",
  "image_url": "https://images.openfoodfacts.org/images/products/000/010/500/0011/front_en.1.400.jpg",
  "price": 1.25,
  "currency": "EUR",
  "categories": ["Teas", "Hot beverages", "Beverages"],
  "attrs": {
    "NOVA group": "1",
    "Energy (kcal/100g)": "280 kcal",
    "Fat (g/100g)": "0 g",
    "Category": "Teas",
    "Price source": "estimated_unit_model",
    "Pricing bucket": "teas",
    "Estimated unit price": "€1.25/unit"
  }
}
```

## Clean data definition
A record is included if it has all of:

- English title: `product_name_en` OR (`lang == en` AND `product_name`)
- English description: `generic_name_en` OR `ingredients_text_en` OR (`lang == en` AND `generic_name`/`ingredients_text`)
- A **front image in English**: `images.front_en` (via `--require-front-lang en`)
- Deterministic synthetic price in a configurable range

## Data is not included in this repo

Users must download the OFF JSONL export at: [https://static.openfoodfacts.org/data/openfoodfacts-products.jsonl.gz](https://static.openfoodfacts.org/data/openfoodfacts-products.jsonl.gz)

Then place it in the data directory:

`data/json_source/openfoodfacts-products.jsonl.gz`

The script reads `.jsonl` or `.jsonl.gz` and streams it; it does not require full decompression.

## Price Estimation

The pricing information is synthetically generated by the `extract.py` script and is not a separate tool. The price estimation logic is based on a product's category, quantity, and other attributes, using the configuration from `config/pricing_buckets.json`. This process is integrated into the main extraction pipeline.

## Project Structure

```text
ecommerce-open-food-facts/
├── data/                  # All data lives here (ignored by git)
│   ├── json_source/       # Raw OFF data dump
│   │   └── openfoodfacts-products.jsonl.gz
│   └── products/          # Processed NDJSON files (The "Output")
├── src/
│   └── off_demo_extract/  # Python Package
│       └── extract.py
├── pyproject.toml         # Dependencies
└── README.md
```

## Quickstart (uv)

Create and run a small sample (recommended first step):

```bash
uv run -m off_demo_extract.extract \
  --require-front-lang en \
  --require-category \
  --output data/products/sample_2k_front_en.ndjson \
  --report data/products/sample_2k_front_en_report.json \
  --max-output-records 2000 \
  --max-input-lines 3000000
```

The script will prompt for confirmation if the output file already exists. To bypass this, add the `--yes` flag.

Run full extraction (no arbitrary cutoff; reads to EOF):

```
uv run -m off_demo_extract.extract \
  --require-front-lang en \
  --require-category \
  --output data/products/off_en_clean_categorized.ndjson \
  --report data/products/report_categorized.json \
  --progress-every 500000
  ```

## Output example

```
{
  "id": "0000159487776",
  "title": "Magic Stars Chocolates",
  "description": "SUGAR, COCOA BUTTER, ...",
  "image_url": "https://images.openfoodfacts.org/images/products/000/015/948/7776/front_en.3.400.jpg",
  "price": 5.58,
  "currency": "EUR",
  "brand": "Milkyway",
  "categories_tags": ["en:null"],
  "lang": "en"
}
```

## Licensing and data reuse (important)
	•	This repository’s code is licensed under the MIT License (see LICENSE).
	•	Open Food Facts data and images are governed by Open Food Facts’ own licenses and terms.

OFF data reuse is based on the Open Database License (ODbL) with attribution and share-alike requirements.  ￼
Image URL construction follows OFF documentation.  ￼

See DATA_LICENSE.md for a concise summary of OFF data obligations and links to the authoritative OFF pages.

## Notes
	•	The Open Food Facts “description” fields are often ingredient lists rather than marketing copy. This is normal for OFF.
	•	The generated price is synthetic and deterministic (stable per barcode) and should not be interpreted as a real market price.

# Data licensing and reuse notes (Open Food Facts)

This repository does **not** distribute Open Food Facts (OFF) data or any derived dataset.
It provides code to transform OFF exports into an NDJSON demo catalog.

## Authoritative sources

Open Food Facts maintains official guidance on:
- Reusing OFF data (ODbL)  [wiki.openfoodfacts.org](https://wiki.openfoodfacts.org/Reusing_Open_Food_Facts_Data)
- ODbL license details on the OFF wiki  [wiki.openfoodfacts.org](https://wiki.openfoodfacts.org/ODBL_License)
- API/data reuse conditions summary (attribution + share-alike)  [support.openfoodfacts.org](https://support.openfoodfacts.org/help/en-gb/12-api-data-reuse/94-are-there-conditions-to-use-the-api)
- Image URL construction for product images  [Open Food Facts](https://openfoodfacts.github.io/openfoodfacts-server/api/how-to-download-images/)
- API overview (open data and reuse framing)  [Open Food Facts](https://openfoodfacts.github.io/openfoodfacts-server/api/)

## What this code does

- Reads the OFF JSONL export (`.jsonl` or `.jsonl.gz`) line-by-line.
- Filters for “clean” English records (title + description + `front_en` image key).
- Computes `image_url` from OFF `images` metadata using OFF’s documented scheme.  [Open Food Facts](https://openfoodfacts.github.io/openfoodfacts-server/api/how-to-download-images/)
- Adds a synthetic deterministic price.

## Important reminder

If you redistribute OFF data or a derived database, you may have obligations under ODbL
(attribution and share-alike). Review OFF’s official guidance and terms before sharing any
datasets generated by this project.  [wiki.openfoodfacts.org](https://wiki.openfoodfacts.org/Reusing_Open_Food_Facts_Data)

This file is informational and not legal advice.